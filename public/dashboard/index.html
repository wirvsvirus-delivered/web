<!DOCTYPE html>
<html lang="de" dir="ltr">

<head>
  <meta charset="utf-8">
  <title>delivered Dashboard</title>
  <link href="img/favicon.png" rel="shortcut icon">
  <link rel="stylesheet" href="css/master.css">
</head>

<body>

  <div class="loader-wrapper" style="display: flex;">
    <div class="loader"></div>
  </div>
  <div class="modal-wrapper modal-newEntry-wrapper">
    <div class="modal modal-newEntry">
      <h2 class="heading">Neuer Auftrag
        <button style="border-radius: 50%; padding: 4px;float: right; background:#ab1c48" onclick="$('.modal-newEntry-wrapper').hide();">
          <i class="material-icons md-18">highlight_off</i>
        </button>
      </h2>
      <form class="form-newEntry">
        <input required type="text" name="fname" placeholder="Vorname">
        <input required type="text" name="lname" placeholder="Nachname">
        <input required type="tel" name="tel" placeholder="Telefonnummer">
        <input required type="number" name="zip" placeholder="PLZ">
        <div class="row">
          <input style="width:70%" required type="text" name="street" placeholder="Stra&szlig;e">
          <input style="width:25%" required type="text" name="num" placeholder="Hausnr.">
        </div>
        <input type="text" name="adressInfo" placeholder="Zus&auml;tzliche Adressinfo">
        <section style="margin-top:10px;">Altersbeschr&auml;nkung<br>
          <input required type="radio" name="age" value="18" id="volljaehrig">&nbsp;
          <label for="volljaehrig">Ab 16</label><br>
          <input required type="radio" name="age" value"16" id="sechzehn">&nbsp;
          <label for="sechzehn">Ab 18</label><br>
          <input required type="radio" name="age" value"0" id="keine">&nbsp;
          <label for="keine">Keine</label><br>
        </section>
        <input required type="datetime" name="data" placeholder="Data">
        <button type="submit">Absenden <i class="material-icons md-18">send</i></button>
      </form>
    </div>
  </div>
  <div class="modal-wrapper modal-searchEntry-wrapper">
    <div class="modal modal-searchEntry">
      <h2 class="heading">Auftr&auml;ge anzeigen
        <button style="border-radius: 50%; padding: 4px;float: right; background:#ab1c48" onclick="$('.modal-searchEntry-wrapper').hide();">
          <i class="material-icons md-18">highlight_off</i>
        </button>
      </h2>
      <form class="form-searchEntry">
        <input required type="text" name="fname" placeholder="Vorname">
        <input required type="text" name="lname" placeholder="Nachname">
        <input required type="number" name="zip" placeholder="PLZ">
        <button type="submit">&Ouml;ffnen <i class="material-icons md-18">launch</i></button>
      </form>
    </div>
  </div>
  <div class="modal-wrapper modal-showEntry-wrapper">
    <div class="modal modal-showEntry">
      <h2 class="heading">Auftr&auml;ge f&uuml;r <span></span>
        <button style="border-radius: 50%; padding: 4px;float: right; background:#ab1c48" onclick="$('.modal-showEntry-wrapper').hide();">
          <i class="material-icons md-18">highlight_off</i>
        </button>
      </h2>
      <div id="entries">
        <hr>
        <section id="zip">
          <h3>PLZ</h3>
          <p></p>
        </section>
      </div>
    </div>
  </div>

  <div class="dashboard-wrapper">
    <div class="dashboard">
      <div class="dashboard-topbar">
        <div class="dashboard-topbar-brand heading"><img src="img/icon.png" alt="delivered"> &nbsp;Dashboard</div>
        <ul class="dashboard-topbar-actions">
          <li style="text-align: right">
            Angemeldet als <br>
            <span id="email"></span>
          </li>
          <li>
            <button onclick="signOut()" style="background:#ab1c48">
              <i class="material-icons">exit_to_app</i>
              Abmelden
            </button>
          </li>
        </ul>
      </div>
      <div class="dashboard-body">
        <h1 class="heading" style="padding-top: 40px;">Auftr&auml;ge</h1>
        <div class="dashboard-body-button-wrapper">
          <div>
            <button onclick="$('.modal-searchEntry-wrapper').css('display', 'flex')">
              <i class="material-icons">visibility</i>
              <span>Auftrag anzeigen</span>
            </button>
          </div>
          <div>
            <button onclick="$('.modal-newEntry-wrapper').css('display', 'flex');">
              <i class="material-icons">add</i>
              <span>Neuer Auftrag</span>
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="/__/firebase/7.12.0/firebase-app.js"></script>
  <script src="/__/firebase/7.12.0/firebase-auth.js"></script>
  <script src="/__/firebase/7.12.0/firebase-firestore.js"></script>
  <script src="/__/firebase/7.12.0/firebase-functions.js"></script>
  <script src="/__/firebase/init.js"></script>
  <script src="js/jquery.js"></script>
  <script>
    firebase.auth().onAuthStateChanged(function(user) {
      if (user) {
        $('#email').html(user.email);
        var db = firebase.firestore();
        var docRef = db.collection("users").doc(user.uid);
        docRef.get().then(function(doc) {
          if (doc.exists) {
            if (doc.data().type === 'telephoner') {
              $('.loader-wrapper').hide();
            } else {
              alert('Du bist kein registrierter Telefonist!');
              firebase.auth().signOut().then(function() {
                window.location.replace('/dashboard/auth/');
              });
              window.location.replace('/dashboard/auth/');
            }
          } else {
            console.log("No such document!");
            firebase.auth().signOut().then(function() {
              window.location.replace('/dashboard/auth/');
            });
            window.location.replace('/dashboard/auth/');
          }
        }).catch(function(error) {
          console.log("Error getting document:", error);
        });
      } else {
        window.location.replace('/dashboard/auth/');
      }
    });


    $(".form-searchEntry").submit(function(event) {
      event.preventDefault();
      $('.loader-wrapper').css('display', 'flex');
      $('.form-searchEntry-wrapper *').hide();
      $('.form-searchEntry-wrapper').hide();
      showEntries(
        $('.form-searchEntry input[name="fname"]').val(),
        $('.form-searchEntry input[name="lname"]').val(),
        parseInt($('.form-searchEntry input[name="zip"]').val()),
      );
      $('.loader-wrapper').hide();
    });

    function showEntries(fname, lname, zip) {
      firebase.functions().httpsCallable('telephonerGetTasks')({
        fname: fname,
        lname: lname,
        zip: zip
      }).then(function(res) {
        if (res.data.state === 'ok') {
          $('#zip p').html(zip);
          $('.modal-showEntry .heading span').html(fname + ' ' + lname)
          for (index in res.data.data) {
            const ref = res.data.data[index];
            $('.modal-showEntry').append(
              generateEntryBlock(
                index + 1,
                ref.street,
                ref.number,
                ref.delivered,
                ref.payed
              )
            )
          }
          $('.modal-showEntry-wrapper').css('display', 'flex')
        } else {
          alert('Fehler: Ungueltige Antwort erhalten')
        }
      }).catch(function(error) {
        console.log(error);
        alert(error);
      });
    }


    function generateEntryBlock(num, street, streetnum, alreadyDelivered, userPayed) {
      var delivered, payed;
      if (alreadyDelivered === true) {
        delivered = 'Ja';
      } else {
        delivered = 'Nein';
      }
      if (userPayed === true) {
        payed = 'Ja';
      } else {
        payed = 'Nein';
      }
      return '<hr>' +
        '<section id="' + num + '">' +
        '<h2 style="margin-bottom: 5px;">Auftrag Nr. <span>' + num + '</span></h2>' +
        '<section id="street">' +
        '<h3>Stra√üe</h3>' +
        '<p>' + street + ' ' + streetnum + '</p>' +
        '</section>' +
        '<section id="delivered">' +
        '<h3>Zugestellt</h3>' +
        '<p>' + delivered + '</p>' +
        '</section>' +
        '<section id="payed">' +
        '<h3>Bezahlt</h3>' +
        '<p>' + payed + '</p>' +
        '</section>' +
        '</section>';
    }
  </script>

</body>

</html>
